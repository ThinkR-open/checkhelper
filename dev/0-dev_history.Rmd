---
title: "Development actions history"
output: html_document
editor_options: 
  chunk_output_type: console
---

All commands that you use to use when developing packages...

# First time just after creating the project

- Fill the following chunk to create the DESCRIPTION of your package

```{r description, eval=FALSE}
# Describe your package
fusen::fill_description(
  pkg = here::here(),
  fields = list(
    Title = "Deal with Check Outputs",
    Description = "Some tools to help you deal with 'devtools::check' outputs and to reduce the risk of rejection of CRAN.",
    `Authors@R` = c(
      person("Sebastien", "Rochette", email = "sebastien@thinkr.fr", role = c("aut", "cre"), comment = c(ORCID = "0000-0002-1565-9313")),
      person("Vincent", "Guyader", email = "vincent@thinkr.fr", role = "aut", comment = c(ORCID = "0000-0003-0671-9270")),
      person(given = "ThinkR", role = "cph")
    )
  )
)
# Define License with use_*_license()
usethis::use_mit_license("ThinkR")
```

# Start using git

```{r, eval=FALSE}
usethis::use_git()
# Deal with classical files to ignore
usethis::git_vaccinate()
# Use main for primary branch
usethis::git_default_branch_rename()
```

# Set extra sources of documentation

```{r, eval=FALSE}
# Install a first time
remotes::install_local()
# README
usethis::use_readme_rmd()
# Code of Conduct
usethis::use_code_of_conduct("codeofconduct@thinkr.fr")
# NEWS
usethis::use_news_md()
```

**From now, you will need to "inflate" your package at least once to be able to use the following commands. Let's go to your flat template, and come back here later if/when needed.**


# Package development tools
## Use once

```{r, eval=FALSE}
# Pipe
usethis::use_pipe()

# package-level documentation
usethis::use_package_doc()
usethis::use_cran_badge()
# [![](https://cranlogs.r-pkg.org/badges/checkhelper)](https://cran.r-project.org/package=checkhelper)
# [![checkhelper status badge](https://thinkr-open.r-universe.dev/badges/checkhelper)](https://thinkr-open.r-universe.dev)

# GitHub
# Add your credentials for GitHub
gitcreds::gitcreds_set()
# Send your project to a new GitHub project
usethis::use_github()

# Set Continuous Integration
# _GitHub
usethis::use_github_action_check_standard()
usethis::use_github_action("pkgdown")
usethis::use_github_action("test-coverage")
# _GitLab
gitlabr::use_gitlab_ci(type = "check-coverage-pkgdown")

# Add new flat template
fusen::add_flat_template("add")
```

## Use everytime needed

```{r}
# Simulate package installation
pkgload::load_all()

# Generate documentation and deal with dependencies
attachment::att_amend_desc(
  pkg_ignore = c("attachment", "usethis"),
  extra.suggests = c("attachment", "usethis"),
  update.config = TRUE
)

# Check the package
devtools::check()
devtools::check(build_args = "no-vignettes")

# Inflate all ----
fusen::inflate_all_no_check()

# Inflate this one manually only when needed and pre-knit its vignette
fusen::inflate(flat_file = "dev/flat_deal-with-check-outputs.Rmd", vignette_name = "Deal with check outputs", check = FALSE, document = TRUE, open_vignette = FALSE)
knitr::knit(
  input = here::here("vignettes/deal-with-check-outputs.Rmd"),
  output = here::here("vignettes/deal-with-check-outputs.Rmd")
)

# Styler ----
styler::style_pkg()
styler::style_file(list.files("dev", pattern = "[.](Rmd|qmd|rmd)$", full.names = TRUE))

# Run local coverage
knitr::knit("dev/README.Rmd", output = "dev/README.md")
```

# Share the package

```{r}
# set and try pkgdown documentation website
usethis::use_pkgdown()
pkgdown::build_site()

# build the tar.gz with vignettes to share with others
devtools::build(vignettes = TRUE)
```

# Prepare for CRAN ----

```{r}
# Check package coverage
covr::package_coverage()

# _Check in interactive test-inflate for templates and Addins
pkgload::load_all()
devtools::test()
testthat::test_dir("tests/testthat/")

# Test no output generated in the user files

# Run examples in interactive mode too
devtools::run_examples()

# Check that the state is clean after check
all_files <- checkhelper::check_clean_userspace()
all_files

# Check package as CRAN
rcmdcheck::rcmdcheck(args = c("--no-manual", "--as-cran"))
# devtools::check(args = c("--no-manual", "--as-cran"))

# Check content
# remotes::install_github("ThinkR-open/checkhelper")
tags <- checkhelper::find_missing_tags() # Toutes les fonctions doivent avoir soit `@noRd` soit un `@export`
tags
checkhelper::check_as_cran()

# Check spelling
# usethis::use_spell_check()
spelling::spell_check_package()

# Check URL are correct
# remotes::install_github("r-lib/urlchecker")
urlchecker::url_check()
urlchecker::url_update()

# Upgrade version number
usethis::use_version(which = c("patch", "minor", "major", "dev")[2])

# check on other distributions
# _rhub
# devtools::check_rhub()
buildpath <- devtools::build()
rhub::platforms()
rhub::check_on_windows(check_args = "--force-multiarch", show_status = FALSE, path = buildpath)
rhub::check_on_solaris(show_status = FALSE, path = buildpath)
rhub::check(platform = "debian-clang-devel", show_status = FALSE, path = buildpath)
rhub::check(platform = "debian-gcc-devel", show_status = FALSE, path = buildpath)
rhub::check(platform = "fedora-clang-devel", show_status = FALSE, path = buildpath)
rhub::check(platform = "macos-highsierra-release-cran", show_status = FALSE, path = buildpath)
rhub::check_for_cran(show_status = FALSE, path = buildpath)

# _win devel
devtools::check_win_devel()
devtools::check_win_release()
# remotes::install_github("r-lib/devtools")
devtools::check_mac_release() # Need to follow the URL proposed to see the results

# Update NEWS
# Bump version manually and add list of changes

# Add comments for CRAN
# Need to .gitignore this file
usethis::use_cran_comments(open = rlang::is_interactive())
usethis::use_git_ignore("cran-comments.md")
usethis::use_git_ignore("CRAN-SUBMISSION")

# Upgrade version number if necessary
usethis::use_version(which = c("patch", "minor", "major", "dev")[1])

# Verify you're ready for release, and release
devtools::release()
```
